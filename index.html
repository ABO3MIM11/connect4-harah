<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ÙƒÙˆÙ†ÙŠÙƒØª 4 Ø§Ù„Ø­Ø§Ø±Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617, #000);
      color: #e0f2ff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px;
    }
    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      padding: 24px 24px 32px;
      box-shadow: 0 0 30px rgba(56, 189, 248, 0.4);
      max-width: 980px;
      width: 100%;
      border: 1px solid rgba(56, 189, 248, 0.6);
    }
    h1 {
      margin: 0;
      text-align: center;
      letter-spacing: 2px;
      font-size: 28px;
      text-shadow: 0 0 12px #38bdf8;
    }
    .subtitle {
      text-align: center;
      font-size: 13px;
      opacity: 0.85;
      margin-top: 4px;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: 270px 1fr;
      gap: 18px;
    }
    @media (max-width: 800px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 16px;
      padding: 14px 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .panel-title {
      font-size: 14px;
      margin-bottom: 8px;
      opacity: 0.9;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: #e0f2ff;
      outline: none;
      font-size: 13px;
    }
    input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-main {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9, #22c1c3);
      color: #0b1120;
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.8);
    }
    .btn-ghost {
      background: transparent;
      color: #e0f2ff;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }
    .small {
      font-size: 12px;
      opacity: 0.75;
      margin-top: 4px;
    }
    .team-toggle {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .team-option {
      flex: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .chip-preview {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.8);
    }
    .chip-blue {
      background: radial-gradient(circle at 30% 30%, #38bdf8, #0ea5e9 40%, #0369a1 100%);
    }
    .chip-orange {
      background: radial-gradient(circle at 30% 30%, #f97316, #ea580c 40%, #9a3412 100%);
      box-shadow: 0 0 8px rgba(248, 150, 75, 0.9);
    }
    .team-option.active-blue {
      border-color: #38bdf8;
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.8);
    }
    .team-option.active-orange {
      border-color: #fb923c;
      box-shadow: 0 0 12px rgba(249, 115, 22, 0.8);
    }
    .players-list {
      margin-top: 8px;
      font-size: 13px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
      background: rgba(148, 163, 184, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .badge-you {
      background: rgba(56, 189, 248, 0.18);
      border-color: rgba(56, 189, 248, 0.8);
    }
    .badge-teamA {
      background: rgba(56, 189, 248, 0.16);
      border-color: rgba(56, 189, 248, 0.6);
    }
    .badge-teamB {
      background: rgba(249, 115, 22, 0.16);
      border-color: rgba(249, 115, 22, 0.7);
    }
    .badge-turn {
      background: rgba(22, 163, 74, 0.18);
      border-color: rgba(22, 163, 74, 0.7);
    }
    .board {
      display: grid;
      grid-template-rows: repeat(6, 1fr);
      grid-auto-flow: row;
      background: radial-gradient(circle at top, #020617, #000);
      border-radius: 18px;
      padding: 10px;
      box-shadow: 0 0 25px rgba(37, 99, 235, 0.7);
      border: 1px solid rgba(59, 130, 246, 0.7);
      max-width: 480px;
      margin: 0 auto;
      aspect-ratio: 7 / 6;
    }
    .board-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .cell {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #020617, #020617 40%, #0f172a 65%, #020617 100%);
      cursor: pointer;
      transition: transform 0.12s;
    }
    .cell:hover {
      transform: translateY(-2px);
    }
    .chip {
      width: 100%;
      height: 100%;
      border-radius: 999px;
    }
    .chip.teamA {
      background: radial-gradient(circle at 30% 30%, #38bdf8, #0ea5e9 40%, #0369a1 100%);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.9);
    }
    .chip.teamB {
      background: radial-gradient(circle at 30% 30%, #f97316, #ea580c 40%, #9a3412 100%);
      box-shadow: 0 0 12px rgba(249, 115, 22, 0.9);
    }
    .status {
      margin-top: 12px;
      font-size: 14px;
      text-align: center;
    }
    .status-cta {
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.82;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ÙƒÙˆÙ†ÙŠÙƒØª 4 Ø§Ù„Ø­Ø§Ø±Ø©</h1>
    <div class="subtitle">ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø³Ø§ÙØ§ÙŠØ± ğŸ”µ Ø¶Ø¯ ÙØ±ÙŠÙ‚ Ø§Ù„Ù†Ø§Ø± Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ğŸŸ  â€” 1 Ø¶Ø¯ 4 Ø£Ùˆ 4 Ø¶Ø¯ 4 Ø¨Ø±Ø§Ø­ØªÙƒÙ…</div>

    <div class="grid">
      <div class="panel">
        <div class="panel-title">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙˆÙ…</div>

        <label for="nameInput">Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ø­Ø§Ø±Ø©</label>
        <input id="nameInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø£Ø¨Ùˆ Ø¹Ù„Ù‘ÙˆØ´" />

        <label style="margin-top:8px;">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</label>
        <div class="team-toggle">
          <div class="team-option active-blue" data-team="A" id="teamAButton">
            <div class="chip-preview chip-blue"></div>
            ÙØ±ÙŠÙ‚ Ø§Ù„Ø³Ø§ÙØ§ÙŠØ± (Ø£Ø²Ø±Ù‚)
          </div>
          <div class="team-option" data-team="B" id="teamBButton">
            <div class="chip-preview chip-orange"></div>
            ÙØ±ÙŠÙ‚ Ø§Ù„Ù†Ø§Ø± (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ)
          </div>
        </div>

        <label for="roomCodeInput" style="margin-top:10px;">ÙƒÙˆØ¯ Ø§Ù„Ø±ÙˆÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="roomCodeInput" placeholder="ÙŠÙÙ†Ø´Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ùˆ ØªØ±ÙƒØªÙ‡ ÙØ§Ø¶ÙŠ" />

        <div class="row">
          <button class="btn-main" id="joinBtn">Ø¥Ù†Ø´Ø§Ø¡ / Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±ÙˆÙ…</button>
          <button class="btn-ghost" id="copyLinkBtn">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø±ÙˆÙ…</button>
        </div>
        <div class="small">
          * Ø§Ø¶ØºØ· â€œØ¥Ù†Ø´Ø§Ø¡ / Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±ÙˆÙ…â€ Ø¨Ø¹Ø¯ Ù…Ø§ ØªÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØªØ®ØªØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚.<br>
          * â€œÙ†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø±ÙˆÙ…â€ ÙŠØ¹Ø·ÙŠÙƒ Ø±Ø§Ø¨Ø· Ø¬Ø§Ù‡Ø² ØªØ±Ø³Ù„Ù‡ Ù„Ø±Ø¨Ø¹Ùƒ â€” Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·.
        </div>

        <div class="players-list" id="playersList"></div>
      </div>

      <div class="panel">
        <div class="panel-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨</div>
        <div id="boardContainer"></div>
        <div class="status" id="statusLabel"></div>
        <div class="status-cta" id="statusHint"></div>
        <div style="text-align:center; margin-top:10px;">
          <button class="btn-ghost" id="newGameBtn">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ROWS = 6;
    const COLS = 7;

    const nameInput = document.getElementById("nameInput");
    const roomCodeInput = document.getElementById("roomCodeInput");
    const joinBtn = document.getElementById("joinBtn");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const playersListEl = document.getElementById("playersList");
    const boardContainer = document.getElementById("boardContainer");
    const statusLabel = document.getElementById("statusLabel");
    const statusHint = document.getElementById("statusHint");
    const newGameBtn = document.getElementById("newGameBtn");
    const teamAButton = document.getElementById("teamAButton");
    const teamBButton = document.getElementById("teamBButton");

    let selectedTeam = "A";
    let ws;
    let roomCode = null;
    let playerId = null; // Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ø¨Ø³ Ø¹Ø´Ø§Ù† Ù†Ø¹Ù„Ù‘Ù… "Ø£Ù†Øª" ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    let board = [];
    let players = [];
    let turnTeam = "A";
    let gameOver = false;
    let winnerTeam = null;

    function randomRoomCode() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for (let i = 0; i < 5; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }

    const params = new URLSearchParams(window.location.search);
    const urlRoom = params.get("room");
    if (urlRoom) {
      roomCodeInput.value = urlRoom.toUpperCase();
      roomCode = urlRoom.toUpperCase();
    }

    function updateUrlRoom(code) {
      const url = new URL(window.location.href);
      url.searchParams.set("room", code);
      window.history.replaceState({}, "", url.toString());
    }

    function setTeam(team) {
      selectedTeam = team;
      if (team === "A") {
        teamAButton.classList.add("active-blue");
        teamBButton.classList.remove("active-orange");
      } else {
        teamBButton.classList.add("active-orange");
        teamAButton.classList.remove("active-blue");
      }
    }

    teamAButton.addEventListener("click", () => setTeam("A"));
    teamBButton.addEventListener("click", () => setTeam("B"));

    function connectWs() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(protocol + "://" + location.host + "/ws");
      ws.addEventListener("open", () => {
        sendJoin();
      });
      ws.addEventListener("message", (ev) => {
        const data = JSON.parse(ev.data);

        if (data.type === "joined") {
          playerId = data.playerId; // Ù†Ù‚Ø¯Ø± Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù„ØªØ¹Ø±ÙŠÙ "Ø£Ù†Øª" ÙÙ‚Ø·
        }

        if (data.type === "state") {
          roomCode = data.roomCode;
          board = data.board;
          players = data.players;
          turnTeam = data.turnTeam;
          gameOver = data.gameOver;
          winnerTeam = data.winnerTeam;
          roomCodeInput.value = roomCode;
          updateUrlRoom(roomCode);
          renderState();
        }

        if (data.type === "error") {
          alert(data.message);
        }
      });
    }

    function send(data) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify(data));
    }

    function sendJoin() {
      const name = nameInput.value.trim() || "Ù„Ø§Ø¹Ø¨ Ù…Ø¬Ù‡ÙˆÙ„";
      if (!roomCode) return;
      send({
        type: "join",
        roomCode,
        name,
        team: selectedTeam
      });
    }

    joinBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      if (!name) {
        alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„ ÙŠØ§ Ù†Ø¬Ù… ğŸ‘€");
        return;
      }
      let code = roomCodeInput.value.trim();
      if (!code) code = randomRoomCode();
      roomCode = code.toUpperCase();
      roomCodeInput.value = roomCode;
      updateUrlRoom(roomCode);
      connectWs();
      setTimeout(sendJoin, 200);
    });

    copyLinkBtn.addEventListener("click", () => {
      let code = roomCodeInput.value.trim();
      if (!code) {
        code = randomRoomCode();
        roomCodeInput.value = code;
      }
      roomCode = code.toUpperCase();
      updateUrlRoom(roomCode);
      const link = window.location.origin + window.location.pathname + "?room=" + encodeURIComponent(roomCode);
      navigator.clipboard.writeText(link).then(() => {
        alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø±ÙˆÙ…! Ø§Ø±Ø³Ù„Ù‡ Ù„Ø±Ø¨Ø¹Ùƒ ğŸ®");
      });
    });

    newGameBtn.addEventListener("click", () => {
      if (!roomCode) return;
      send({ type: "newGame", roomCode });
    });

    function handleColumnClick(col) {
      if (!roomCode) {
        alert("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±ÙˆÙ… Ø¨Ø§Ø³Ù…Ùƒ ÙˆÙØ±ÙŠÙ‚Ùƒ Ø£ÙˆÙ„ ğŸ”¥");
        return;
      }
      // Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØªØ­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù† Ø·Ø±ÙŠÙ‚ ws.idØŒ playerId Ù‡Ù†Ø§ ÙÙ‚Ø· Ù„Ù„Ù€ UI
      send({ type: "move", roomCode, col, playerId });
    }

    function renderBoard() {
      if (!board || !board.length) {
        boardContainer.innerHTML =
          '<div style="text-align:center; font-size:13px; opacity:0.7;">Ø§Ù„Ù„ÙˆØ­Ø© Ø¨ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ¯Ø®Ù„ Ø§Ù„Ø±ÙˆÙ….</div>';
        return;
      }
      boardContainer.innerHTML = "";
      const boardEl = document.createElement("div");
      boardEl.className = "board";

      for (let r = 0; r < ROWS; r++) {
        const rowEl = document.createElement("div");
        rowEl.className = "board-row";
        for (let c = 0; c < COLS; c++) {
          const cellEl = document.createElement("div");
          cellEl.className = "cell";
          cellEl.addEventListener("click", () => handleColumnClick(c));
          const val = board[r][c];
          if (val === "A" || val === "B") {
            const chip = document.createElement("div");
            chip.className = "chip " + (val === "A" ? "teamA" : "teamB");
            cellEl.appendChild(chip);
          }
          rowEl.appendChild(cellEl);
        }
        boardEl.appendChild(rowEl);
      }
      boardContainer.appendChild(boardEl);
    }

    function renderPlayers() {
      if (!players || !players.length) {
        playersListEl.innerHTML =
          '<span class="small">Ù…Ø§ ÙÙŠÙ‡ Ø£Ø­Ø¯ Ø¨Ø§Ù„Ø±ÙˆÙ… Ù„Ù„Ø­ÙŠÙ†. Ø³ÙˆÙ‘Ù Ø±ÙˆÙ… ÙˆØ§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø±Ø¨Ø¹Ùƒ.</span>';
        return;
      }

      const lines = players.map((p) => {
        const you = p.id === playerId;
        const badges = [];
        if (p.team === "A") badges.push('<span class="badge badge-teamA">ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</span>');
        if (p.team === "B") badges.push('<span class="badge badge-teamB">ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</span>');
        if (you) badges.push('<span class="badge badge-you">Ø£Ù†Øª</span>');
        return `<div>${p.name} ${badges.join(" ")}</div>`;
      });

      playersListEl.innerHTML = lines.join("");
    }

    function renderStatus() {
      if (!roomCode) {
        statusLabel.textContent = "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ ÙˆØ§Ø¶ØºØ· (Ø¥Ù†Ø´Ø§Ø¡ / Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±ÙˆÙ…).";
        statusHint.textContent = "";
        return;
      }

      const teamACount = players.filter((p) => p.team === "A").length;
      const teamBCount = players.filter((p) => p.team === "B").length;

      if (!players.length) {
        statusLabel.textContent = `Ø±ÙˆÙ… ${roomCode} Ø¬Ø§Ù‡Ø²ØŒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ ÙŠØ¯Ø®Ù„.`;
        statusHint.textContent = "";
        return;
      }

      if (gameOver) {
        if (winnerTeam === null) {
          statusLabel.textContent = "ØªØ¹Ø§Ø¯Ù„! Ù…Ø§ Ø£Ø­Ø¯ ÙØ§Ø² ğŸ˜…";
        } else if (winnerTeam === "A") {
          statusLabel.textContent = "ÙØ§Ø² ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø³Ø§ÙØ§ÙŠØ±! ğŸ”µğŸ”¥";
        } else {
          statusLabel.textContent = "ÙØ§Ø² ÙØ±ÙŠÙ‚ Ø§Ù„Ù†Ø§Ø± Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ! ğŸŸ ğŸ”¥";
        }
        statusHint.textContent = "Ø§Ø¶ØºØ· (Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©) Ø¹Ø´Ø§Ù† ØªØ¹ÙŠØ¯ÙˆÙ† Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ù†ÙØ³ Ø§Ù„Ø±ÙˆÙ….";
        return;
      }

      const teamName = (team) =>
        team === "A" ? "ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø³Ø§ÙØ§ÙŠØ± ğŸ”µ" : "ÙØ±ÙŠÙ‚ Ø§Ù„Ù†Ø§Ø± Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ğŸŸ ";

      statusLabel.textContent = `Ø¯ÙˆØ± ${teamName(turnTeam)}`;
      statusHint.textContent =
        "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø²Ø±Ù‚: " + teamACount + " | Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ: " + teamBCount;
    }

    function renderState() {
      renderBoard();
      renderPlayers();
      renderStatus();
    }

    // Ø£ÙˆÙ„ Ø±Ù†Ø¯Ø± Ù…Ø¨Ø¯Ø¦ÙŠ
    renderState();
  </script>
</body>
</html>
